- name: Deploy Docker Stack
  hosts: swarm_manager
  become: yes
  tasks:
    # - name: Install Docker SDK for Python
    #   pip:
    #     name: docker
    #   become_user: root
    #   become: yes
    #   become_method: sudo
    #   vars:
    #     ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

    # - name: Convert Docker Compose to Docker Stack
    #   command: docker stack deploy -c ./docker-compose.yaml ansible_stack
    #   become_user: "{{ ansible_user }}"

    # - name: Clone Git repository
    #   command: git clone -b restructure https://github.com/Samagra-Development/ai-tools /home/manas/Codes/ansible/
    - name: Clone Git repository
      git:
        repo: https://github.com/Samagra-Development/ai-tools
        dest: /home/manas/Codes/ansible
        version: restructure


    # - name: Run commands in the cloned directory
    #   shell: |
    #     ./generate.sh
    #   args:
    #     chdir: /home/manas/Codes/ansible
    #   become_user: root
    #   become: yes
    #   become_method: sudo
    #   vars:
    #     ansible_ssh_common_args: '-o StrictHostKeyChecking=no'
    
    # - name: Example Vault Playbook
    #   hosts: localhost
    #   vars:
    #     vault_address: "http://127.0.0.1:8200"
    #     vault_token: hvs.jG41S4oPtgvnGX3mgmosE1Nr
    #     vault_secret_path: "secret/myapp"
    #     vault_field: "envfile"
    #   tasks:
    #     - name: Retrieve secret from Vault
    #       command: vault kv get -field={{ vault_field }} -format=json {{ vault_secret_path }}
    #       args:
    #         executable: /usr/local/bin/vault
    #         environment:
    #           VAULT_ADDR: "{{ vault_address }}"
    #           VAULT_TOKEN: "{{ vault_token }}"
    #       register: secret_result
     


    - name: Retrieve environment file from Vault
      vars:
          vault_address: "http://127.0.0.1:8200"
          vault_token: hvs.jG41S4oPtgvnGX3mgmosE1Nr
          vault_secret_path: "secret/myapp"
          vault_field: "envfile"
      command: vault kv get -field=value -format=json secret/myapp/envfile
      changed_when: false
      args:
        chdir: /home/manas/Codes/ansible
        executable: /usr/local/bin/vault
      environment:
        VAULT_ADDR: "{{ vault_address }}"
        VAULT_TOKEN: "{{ vault_token }}"

    - name: Convert Docker Compose to Docker Stack
      command: docker stack deploy -c ./docker-compose-generated.yaml ansible_stack
      become_user: "{{ ansible_user }}"
      environment: './sample_env_file.env'
      args:
        chdir: /home/manas/Codes/ansible

    # - name: Run commands in repository directory
    #   command: ./generate.sh
    #   become_user: root
    #   become: yes
    #   become_method: sudo
    #   vars:
    #     ansible_ssh_common_args: '-o StrictHostKeyChecking=no'